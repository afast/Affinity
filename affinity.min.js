var AffineTransformation=function(){function e(e,t){this.from=e;this.to=t;this.dimensions=2;if(this.from.length!==this.to.length){throw"Both from and to must be of same size"}if(this.from.length===0){this.buildNoOpMatrix();return}if(this.from.length===1){this.buildTranslationMatrix();return}if(this.from.length===2){this.addHelpPoint()}if(this.to.length<(this.dimensions=this.to[0].length)){throw"Too few points => under-determined system"}this.buildHelpMatrices();if(!this.gaussJordan(this.m)){this.addHelpPoint();this.buildHelpMatrices();if(!this.gaussJordan(this.m)){throw"sorry, can't help you"}}}e.prototype.gaussJordan=function(e){var t;var n=1/Math.pow(10,10),r=e.length,i=e[0].length;for(var s=0,o=s;r>=0?o<r:o>r;s=0<=r?++o:--o){t=s;for(var u=s+1,a=u,f=u;f<=r?a<r:a>r;u=f<=r?++a:--a){if(Math.abs(e[u][s])>Math.abs(e[t][s])){t=u}}var l=[e[t],e[s]];e[s]=l[0];e[t]=l[1];if(Math.abs(e[s][s])<=n){return false}for(var u=s+1,c=u,h=u;h<=r?c<r:c>r;u=h<=r?++c:--c){var p=e[u][s]/e[s][s];for(var d=s,v=d;s<=i?v<i:v>i;d=s<=i?++v:--v){e[u][d]-=e[s][d]*p}}}for(var s=r-1,m=s,g=s;g<=0?m<=0:m>=0;s=g<=0?++m:--m){var p=e[s][s];for(var u=0,y=u;s>=0?y<s:y>s;u=0<=s?++y:--y){for(var d=i-1,b=d,w=d;w<=s?b<=s:b>=s;d=w<=s?++b:--b){e[u][d]-=e[s][d]*e[u][s]/p}}e[s][s]/=p;for(var d=r,E=d;r<=i?E<i:E>i;d=r<=i?++E:--E){e[s][d]/=p}}return true};e.prototype.transformation_matrix=function(){if(this.matrix){return this.matrix}this.matrix=[];for(var e=0,t=e,n=this.dimensions;n>=0?t<n:t>n;e=0<=n?++t:--t){this.matrix[e]=[];for(var r=0,i=r,s=this.dimensions;0<=s?i<s:i>s;r=0<=s?++i:--i){this.matrix[e].push(parseFloat(this.m[r][e+this.dimensions+1]))}this.matrix[e].push(parseFloat(this.m[this.dimensions][e+this.dimensions+1]))}return this.matrix};e.prototype.buildNoOpMatrix=function(){return this.matrix=[[1,0,0],[0,1,0]]};e.prototype.buildTranslationMatrix=function(){return this.matrix=[[1,0,this.to[0][0]-this.from[0][0]],[0,1,this.to[0][1]-this.from[0][1]]]};e.prototype.transformation_matrix_m=function(){return $M(this.transformation_matrix())};e.prototype.inverseTransformationMatrix=function(){var e;var t=function(){var t=[];var n=this.transformation_matrix_m().elements;for(var r=0,i=n.length;r<i;r++){e=n[r];t.push(e)}return t}.call(this);t.push([0,0,1]);return $M(t).inverse()};e.prototype.transform=function(e){return this.transformWithMatrix(e,this.transformation_matrix_m())};e.prototype.inverseTransform=function(e){return this.transformWithMatrix(e,this.inverseTransformationMatrix())};e.prototype.transformWithMatrix=function(e,t){var n;e=e.slice(0,2);e.push(1);var r=$M(function(){var t=[];for(var r=0,i=e.length;r<i;r++){n=e[r];t.push([n])}return t}());var i=t.x(r);return function(){var e=i.elements,t=[];for(var r=0,s=e.length;r<s;r++){n=e[r];t.push(n[0])}return t}().slice(0,2)};e.prototype.addHelpPoint=function(){var e;e=[];e[0]=[-1*(this.from[1][1]-this.from[0][1])+this.from[0][1],this.from[1][0]-this.from[0][0]+this.from[0][0]];e[1]=[-1*(this.to[1][1]-this.to[0][1])+this.to[0][1],this.to[1][0]-this.to[0][0]+this.to[0][0]];this.from.push(e[0]);return this.to.push(e[1])};e.prototype.buildHelpMatrices=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w;this.c=function(){var n,r,i;i=[];for(t=n=0,r=this.dimensions;0<=r?n<=r:n>=r;t=0<=r?++n:--n){i.push(function(){var t,n,r;r=[];for(e=t=0,n=this.dimensions;0<=n?t<n:t>n;e=0<=n?++t:--t){r.push(0)}return r}.call(this))}return i}.call(this);for(n=u=0,v=this.dimensions;0<=v?u<v:u>v;n=0<=v?++u:--u){for(r=a=0,m=this.dimensions;0<=m?a<=m:a>=m;r=0<=m?++a:--a){g=this.from;for(t=f=0,c=g.length;f<c;t=++f){i=g[t];o=i.concat([1]);this.c[r][n]+=o[r]*this.to[t][n]}}}this.q=function(){var n,r,i;i=[];for(t=n=0,r=this.dimensions;0<=r?n<=r:n>=r;t=0<=r?++n:--n){i.push(function(){var t,n,r;r=[];for(e=t=0,n=this.dimensions;0<=n?t<=n:t>=n;e=0<=n?++t:--t){r.push(0)}return r}.call(this))}return i}.call(this);y=this.from;for(l=0,h=y.length;l<h;l++){s=y[l];o=s.concat([1]);for(t=p=0,b=this.dimensions;0<=b?p<=b:p>=b;t=0<=b?++p:--p){for(n=d=0,w=this.dimensions;0<=w?d<=w:d>=w;n=0<=w?++d:--d){this.q[t][n]+=o[t]*o[n]}}}return this.m=function(){var e,n,r;r=[];for(t=e=0,n=this.dimensions;0<=n?e<=n:e>=n;t=0<=n?++e:--e){r.push(this.q[t].concat(this.c[t]))}return r}.call(this)};return e}();(typeof global!=="undefined"&&global!==null?global:window).AffineTransformation=AffineTransformation